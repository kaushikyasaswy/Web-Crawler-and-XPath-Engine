package edu.upenn.cis455.servlet;

import java.io.IOException;
import java.io.PrintWriter;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.Enumeration;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.sleepycat.je.Environment;
import com.sleepycat.je.Transaction;

import edu.upenn.cis455.storage.*;
import edu.upenn.cis455.xpathengine.XPathEngineFactory;
import edu.upenn.cis455.xpathengine.XPathEngineImpl;

public class CreateChannelServlet extends HttpServlet{

	private DBWrapper wrapper;
	private String directory;
	private Indices pk_index;
	private String username;
	private Environment env;

	public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
		//username = (String) request.getSession().getServletContext().getAttribute("uname");
		username = request.getParameter("uname");
		response.sendRedirect("NewChannel.html");
	}

	public void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException {
		PrintWriter out = response.getWriter();
		XPathEngineImpl xpathengine = (XPathEngineImpl) XPathEngineFactory.getXPathEngine();
		ArrayList<String> xpaths = new ArrayList<String>();
		Enumeration e = request.getParameterNames();
		String xslt_url = null;
		String channel_name = null;
		while(e.hasMoreElements()) {
			String param = e.nextElement().toString();
			if (param.equals("cname")) {
				channel_name = request.getParameter(param);
			}
			else if (param.equals("xslt")) {
				xslt_url = URLDecoder.decode(request.getParameter(param), "UTF-8");
				if (!xslt_url.startsWith("http"))
					xslt_url = "http://" + xslt_url;
			}
			else if (param.startsWith("xpath_")) {
				xpaths.add(URLDecoder.decode(request.getParameter(param), "UTF-8"));
			}
		}
		String[] xpaths_array = new String[xpaths.size()];
		xpaths_array = xpaths.toArray(xpaths_array);
		xpathengine.setXPaths(xpaths_array);
		for (int i=0; i<xpaths.size(); i++) {
			if (!xpathengine.isValid(i)) {
				// Invalid XPath
				out.println("<!DOCTYPE html><html><head><style>.input {border: 3px solid;width: 40em;}.breaks {clear: both;}.add {	width: 20em;	text-align: center;	background: lightblue;	border: 3px solid}.sub {	position: absolute;	display: block;	width: 20em;	text-align: center;	float: left;	background: lightblue;	border: 3px solid}.group {	display: block;}.labels {	display: block;	padding-top: .1em;	padding-right: .25em;	width: 10em;	text-align: right;	float: left;}</style>");
				out.println("</head><body><form action=\"createchannel\" method=\"post\">	<p><font style=\"color:red\">You entered an Invalid XPath! Please try again!</font></p><br> <input name=\"uname\" value=\""+username+"\" style=\"visibility:hidden\">	<br>	<div id=\"name\">			<div class=\"group\"> 			<label class=\"labels\">Channel Name:</label> <input name=\"cname\" id=\"cname\" /></div></div><div class=\"breaks\"><br></div><div id=\"urls\"><div class=\"group\"><label class=\"labels\">XSLT URL:</label> <input name=\"xslt\" id=\"xslt\" /></div></div><div class=\"breaks\"><br></div><div id=\"textboxes\"><div class=\"group\"><label class=\"labels\">Xpath:</label> <input name=\"xpath_1\" id=\"xpath_1\" />");
				out.println("</div></div><div class=\"breaks\"><br></div><div class=\"btn\"><p><button class=\"add\" type=\"button\" onclick=\"myFunction()\">Add another xpath</button></p></div><script>var index = 2;function myFunction() {var new_div = document.createElement(\"div\");new_div.setAttribute(\"class\", \"group\");var ele = document.createElement(\"label\");ele.setAttribute(\"class\", \"labels\");ele.innerHTML = \"Xpath:\";var element = document.createElement(\"input\");element.setAttribute(\"type\", \"text\");element.setAttribute(\"value\", \"\");element.setAttribute(\"name\", \"xpath_\" + index);element.setAttribute(\"id\", \"xpath_\" + index);var division = document.getElementById(\"textboxes\");new_div.appendChild(ele);new_div.appendChild(element);division.appendChild(new_div);index++;}");
				out.println("</script><div class=\"sub_div\"><p><button class=\"sub\" type=\"submit\" value=\"Submit\">Create Channel</button></p></div></form></body></html>");
				out.close();
				return;
			}
		}
		directory = request.getSession().getServletContext().getInitParameter("BDBstore");
		opendb();
		pk_index = new Indices(wrapper.getStore());
		env = wrapper.getEnvironment();
		Users p = pk_index.users_pk.get(username);
		ArrayList<String> channels = p.getChannels();
		channels.add(channel_name);
		p.setChannels(channels);
		Transaction txn = env.beginTransaction(null, null);
		try {
			pk_index.users_pk.put(p);
			txn.commit();
		}
		catch(Exception e1) {
			System.out.println("Transaction failed");
			if (txn != null) {
				txn.abort();
				txn = null;
			}
		}
		Channels c = new Channels();
		c.setUsername(username);
		c.setChannelName(channel_name);
		c.setXsltURL(xslt_url);
		c.setXPaths(xpaths);
		c.setMatchedURLS(new ArrayList<String>());
		Transaction txn2 = env.beginTransaction(null, null);
		try {
			pk_index.channels_pk.put(c); // Assuming that only unique channels are entered
			txn2.commit();
		}
		catch(Exception e1) {
			System.out.println("Transaction failed");
			if (txn2 != null) {
				txn2.abort();
				txn2 = null;
			}
		}
		wrapper.shutdown(); // Close the database
		out.println("<!DOCTYPE html><html><head></head><body><h1><font style=\"color: green\">Channel create successfully</font></h1><br></body></html>");
		out.close();
	}

	/**
	 * Function that opens the database
	 */
	public void opendb() {
		wrapper = new DBWrapper();
		wrapper.setup(directory);
	}

}
